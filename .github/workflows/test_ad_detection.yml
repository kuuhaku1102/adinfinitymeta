name: Test Ad Detection

on:
  workflow_dispatch:

jobs:
  test-ad-detection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests python-dotenv gspread oauth2client
      
      - name: Create .env file
        run: |
          cat << EOF > .env
          ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}
          ACCOUNT_IDS=${{ secrets.ACCOUNT_ID }}
          CAMPAIGN_IDS=${{ secrets.CAMPAIGN_IDS }}
          SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID=${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          SPREADSHEET_URL=${{ secrets.SPREADSHEET_URL }}
          GSHEET_JSON=${{ secrets.GSHEET_JSON }}
          EOF
      
      - name: Run ad detection test
        run: |
          python3 meta_abtest_runner.py
      
      - name: Check Slack reactions
        run: |
          echo "広告停止候補がSlackに通知されました"
          echo "Slackチャンネルで確認してください"
          if [ -f slack_reactions.json ]; then
            echo "リアクションデータ:"
            cat slack_reactions.json
          fi
